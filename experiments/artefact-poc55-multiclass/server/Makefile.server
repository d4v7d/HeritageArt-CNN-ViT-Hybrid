.PHONY: help verify-dataset download verify test train-convnext train-swin train-maxvit \
        train-all status logs logs-live cancel clean-logs clean-training clean-all clean

help:
	@echo "POC-5.5: SLURM Deployment (CITIC Server)"
	@echo "=========================================="
	@echo ""
	@echo "Setup:"
	@echo "  make verify-dataset - Check dataset"
	@echo "  make download       - Smart download"
	@echo "  make verify         - Verify environment"
	@echo ""
	@echo "Testing:"
	@echo "  make test           - 1-epoch test (3-5 min)"
	@echo "  make test-v100      - V100 optimized test (validates 4x speedup)"
	@echo ""
	@echo "Training (submit to GPU nodes):"
	@echo "  make train-convnext - ConvNeXt job"
	@echo "  make train-swin     - Swin job"
	@echo "  make train-maxvit   - MaxViT job"
	@echo "  make train-all      - All 3 parallel"
	@echo ""
	@echo "Monitoring:"
	@echo "  make status    - Job status"
	@echo "  make logs      - View logs"
	@echo "  make logs-live - Follow live"
	@echo "  make cancel    - Cancel jobs"
	@echo ""
	@echo "Cleanup:"
	@echo "  make clean-logs     - Remove SLURM logs"
	@echo "  make clean-training - Remove training outputs"
	@echo "  make clean-all      - Remove everything"

verify-dataset:
	@if [ -d "../data/artefact/images" ]; then \
		IMG_COUNT=$$(find ../data/artefact/images -type f | wc -l); \
		echo "âœ… Dataset: $$IMG_COUNT images"; \
		du -sh ../data/artefact; \
		[ $$IMG_COUNT -eq 418 ] && echo "âœ… COMPLETE" || echo "âš ï¸  INCOMPLETE"; \
	else \
		echo "âŒ Dataset NOT FOUND"; \
	fi

download:
	@echo "ðŸ“¥ Smart dataset download..."
	bash download_dataset_server.sh

verify:
	@module load miniconda3 && \
	conda activate poc55 && \
	python -c "import torch, timm; print(f'âœ… PyTorch: {torch.__version__}'); print(f'âœ… timm: {timm.__version__}')"

test:
	@mkdir -p ../logs/slurm
	@echo "ðŸ§ª Submitting 1-epoch test (validates CUDA + dataset)..."
	@sbatch slurm_test_1epoch.sh
	@echo ""
	@echo "ðŸ“Š Monitor: make status"
	@echo "ðŸ“‹ Logs: make logs-live"

test-v100:
	@mkdir -p ../logs/slurm
	@echo "ðŸš€ Submitting V100-optimized test (384px, batch=48)..."
	@sbatch slurm_test_v100.sh
	@echo ""
	@echo "Expected: ~15-20s/epoch, >30 imgs/s, 15-20GB VRAM"
	@echo "vs old: 37s/epoch, 9.1 imgs/s, 2GB VRAM"
	@echo ""
	@echo "ðŸ“Š Monitor: make status"
	@echo "ðŸ“‹ Logs: make logs-live"

train-convnext:
	@mkdir -p ../logs/slurm
	sbatch slurm_train_convnext.sh
	@echo "âœ… ConvNeXt submitted!"

train-swin:
	@mkdir -p ../logs/slurm
	sbatch slurm_train_swin.sh
	@echo "âœ… Swin submitted!"

train-maxvit:
	@mkdir -p ../logs/slurm
	sbatch slurm_train_maxvit.sh
	@echo "âœ… MaxViT submitted!"

train-all:
	@mkdir -p ../logs/slurm
	@sbatch slurm_train_convnext.sh
	@sbatch slurm_train_swin.sh
	@sbatch slurm_train_maxvit.sh
	@echo ""
	@echo "âœ… All 3 jobs submitted!"
	@echo "Monitor: make status"

status:
	@echo "ðŸ“Š SLURM Jobs:"
	@squeue -u btrigueros --format="%.10i %.15j %.8T %.10M %.6D %R" || echo "None running"

logs:
	@for log in ../logs/slurm/*.out; do [ -f "$$log" ] && tail -30 "$$log"; done

logs-live:
	@tail -f $$(ls -t ../logs/slurm/*.out 2>/dev/null | head -1)

cancel:
	@scancel -u btrigueros --name=poc55-convnext
	@scancel -u btrigueros --name=poc55-swin
	@scancel -u btrigueros --name=poc55-maxvit
	@scancel -u btrigueros --name=poc55-test
	@echo "âœ… Jobs cancelled"

clean-logs:
	@echo "ðŸ§¹ Cleaning SLURM logs..."
	@rm -rf ../logs/slurm/*.{out,err}
	@echo "âœ… SLURM logs cleaned"

clean-training:
	@echo "ðŸ§¹ Cleaning training outputs..."
	@rm -rf ../logs/poc55_*
	@echo "âœ… Training logs cleaned"

clean-all: clean-logs clean-training
	@echo "âœ… All cleanup complete"

clean:
	@read -p "Remove ALL logs (SLURM + training)? [y/N]: " c && [ "$$c" = "y" ] && $(MAKE) clean-all
